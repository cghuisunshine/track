<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medication + Vitals Tracker</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; line-height: 1.3; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .sub { opacity: .8; margin-bottom: 14px; }
    .grid { display: grid; gap: 14px; grid-template-columns: 1fr; }
    @media (min-width: 980px) { .grid { grid-template-columns: 1.2fr .8fr; } }

    .card { border: 1px solid rgba(127,127,127,.35); border-radius: 12px; padding: 14px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 0 0 auto; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid rgba(127,127,127,.25); vertical-align: top; }
    th { text-align: left; font-weight: 650; font-size: 12px; opacity: .85; }
    td { font-size: 14px; }

    .cellMain { display: block; }
    .cellSub { display: block; margin-top: 4px; }

    button, input, select {
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: transparent;
    }
    textarea {
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: transparent;
      width: 100%;
      max-width: 100%;
      min-width: 240px;
      min-height: 90px;
      resize: vertical;
    }
    button { cursor: pointer; }
    button.primary { font-weight: 650; }
    button.small { padding: 6px 10px; border-radius: 9px; font-size: 13px; }
    input.small { padding: 6px 10px; border-radius: 9px; font-size: 13px; width: 70px; }
    input[type="number"] { width: 110px; }
    .dtInput { min-width: 210px; }

    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      border-radius: 999px; padding: 6px 10px; font-size: 12px; font-weight: 650;
      border: 1px solid rgba(127,127,127,.35);
      white-space: nowrap;
    }
    .ok { background: rgba(0, 200, 0, .12); }
    .soon { background: rgba(255, 165, 0, .18); }
    .due { background: rgba(255, 75, 75, .20); }
    .over { background: rgba(160, 0, 255, .18); }

    .muted { opacity: .75; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right { text-align: right; }
    .nowrap { white-space: nowrap; }

    .danger { color: #b00020; }
    .footer { margin-top: 12px; opacity: .7; font-size: 12px; }
  </style>
</head>
<body>
  <div class="row" style="justify-content: space-between; align-items: baseline;">
    <h1 id="pageTitle">Medication + Vitals Tracker</h1>
    <label class="muted" style="display:inline-flex; align-items:center; gap:8px;">
      <span id="langLabel">Language</span>
      <select id="langSel">
        <option value="zh" selected>中文</option>
        <option value="en">English</option>
      </select>
    </label>
  </div>
  <div class="sub" aria-hidden="true"></div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <div>
          <div class="muted" id="medScheduleTitle">Medication schedule</div>
          <div class="muted" id="colorLegend">Colors: <span class="pill ok">OK</span> <span class="pill soon">DUE SOON</span> <span class="pill due">DUE NOW</span> <span class="pill over">OVERDUE</span></div>
        </div>
        <div class="row">
          <label class="muted"><span id="soonWindowLabel">Due soon window</span>:
            <select id="soonWindow">
              <option value="15" id="soon15">15 min</option>
              <option value="30" selected id="soon30">30 min</option>
              <option value="60" id="soon60">60 min</option>
            </select>
          </label>
          <button class="small" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <div style="overflow:auto; margin-top: 10px;">
        <table id="medTable">
          <thead>
            <tr>
              <th id="thMedicine">Medicine</th>
              <th class="nowrap" id="thEachTime">Each time</th>
              <th class="nowrap" id="thEvery">Every</th>
              <th class="nowrap" id="thLastTaken">Last taken</th>
              <th class="nowrap" id="thNextDose">Next dose</th>
              <th id="thStatus">Status</th>
              <th class="right" id="thActions">Actions</th>
            </tr>
          </thead>
          <tbody><!-- injected --></tbody>
        </table>
      </div>

      <div class="row" style="margin-top: 12px;">
        <button id="resetAllBtn" class="small">Reset all</button>
        <button id="exportBtn" class="small">Export JSON</button>
        <label class="small" style="display:inline-flex; align-items:center; gap:8px;">
          <span id="importLabel">Import JSON</span>
          <input id="importFile" type="file" accept="application/json" />
        </label>
      </div>

      <div class="footer">
        <span id="tipText">Tip: When you take a medicine, click <b>Take now</b> — it stores the exact timestamp and calculates the next dose.</span>
      </div>
    </div>

    <div class="card">
      <div class="muted" id="vitalsTitle">Vitals (Temperature + Heart Rate)</div>

      <div class="row" style="margin-top: 10px;">
        <label><span id="vitalsTimeLabel">Time</span>
          <input id="vitalsTimeInput" class="dtInput" type="text" placeholder="YYYY-MM-DD HH:MM" />
        </label>
        <label><span id="tempLabel">Temp</span> (°C)
          <input id="tempInput" type="number" step="0.1" placeholder="37.2" />
        </label>
        <label><span id="hrLabel">Heart rate</span> (bpm)
          <input id="hrInput" type="number" step="1" placeholder="88" />
        </label>
        <button id="addVitalsBtn" class="primary">Add</button>
      </div>

      <div class="muted" style="margin-top: 8px;">
        <span id="vitalsHelp">Enter Temp and/or HR. If you enter both, they are saved as two separate items at the same time.</span>
      </div>

      <div style="overflow:auto; margin-top: 10px;">
        <table id="vitalsTable">
          <thead>
            <tr>
              <th class="nowrap" id="thVitalsTime">Time</th>
              <th class="nowrap" id="thVitalsTemp">Temp (°C)</th>
              <th class="nowrap" id="thVitalsHr">HR (bpm)</th>
              <th class="right" id="thVitalsActions">Actions</th>
            </tr>
          </thead>
          <tbody><!-- injected --></tbody>
        </table>
      </div>

      <div style="margin-top: 14px; border-top: 1px solid rgba(127,127,127,.25); padding-top: 14px;">
        <div class="muted" id="notesTitle">Notes (standalone timeline)</div>

        <div class="row" style="margin-top: 10px; align-items: flex-start;">
          <label><span id="notesTimeLabel">Time</span>
            <input id="notesTimeInput" class="dtInput" type="text" placeholder="YYYY-MM-DD HH:MM" />
          </label>
          <label style="flex: 1 1 320px;"><span id="notesFeelLabel">How I feel</span>
            <textarea id="notesTextInput" placeholder="e.g., sore throat improving, mild headache, tired"></textarea>
          </label>
          <button id="addNoteBtn" class="primary">Add note</button>
        </div>

        <div style="overflow:auto; margin-top: 10px;">
          <table id="notesTable">
            <tbody><!-- injected --></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  // --------- UI LANGUAGE ----------
  const UI_LS_KEY = "med_tracker_ui_v1";
  const I18N = {
    zh: {
      pageTitle: "用药与体征记录",
      langLabel: "语言",

      medScheduleTitle: "用药计划",
      colorLegendHtml: `颜色： <span class="pill ok">正常</span> <span class="pill soon">即将到点</span> <span class="pill due">到点</span> <span class="pill over">已超时</span>`,
      soonWindowLabel: "即将到点窗口",
      soon15: "15 分钟",
      soon30: "30 分钟",
      soon60: "60 分钟",
      refresh: "刷新",

      thMedicine: "药品",
      thEachTime: "每次",
      thEvery: "间隔",
      thLastTaken: "上次服用",
      thNextDose: "下次服用",
      thStatus: "状态",
      thActions: "操作",

      resetAll: "全部重置",
      exportJson: "导出 JSON",
      importJson: "导入 JSON",

      tipHtml: `提示：服药后点击 <b>现在服用</b>，系统会记录时间并计算下次服用。`,

      takeNow: "现在服用",
      setTime: "设置时间",

      vitalsTitle: "体征（体温 + 心率）",
      time: "时间",
      temp: "体温",
      hr: "心率",
      add: "添加",
      vitalsHelp: "输入体温和/或心率；如果两者都输入，会在同一时间保存为两条记录。",

      thVitalsTime: "时间",
      thVitalsTemp: "体温 (°C)",
      thVitalsHr: "心率 (bpm)",
      thVitalsActions: "操作",

      notesTitle: "感受记录",
      howIFeel: "我的感受",
      addNote: "添加备注",
      notesPlaceholder: "例如：喉咙痛减轻、轻微头痛、疲惫",

      delete: "删除",

      status_ok: "正常",
      status_soon: "即将到点",
      status_due: "到点",
      status_over: "已超时",

      alertEnterVitals: "请先输入体温和/或心率。",
      alertEnterNote: "请先输入备注内容。",
      alertInvalidTime: "时间格式不正确。",
      alertPiecesPositive: "每次用量必须是大于 0 的数字。",
      resetConfirm: "重置所有用药 + 体征 + 备注？这会清除本地数据。",
      imported: "已导入！",
      importFailed: "导入失败。请确认是从本页面导出的 JSON 文件。",
      timeHintFull: "YYYY-MM-DD HH:MM",
      timeHintShort: "MM-DD HH:MM（或 YYYY-MM-DD HH:MM）",
      promptSetLastTaken: "设置 {name} 的上次服用时间（格式：{fmt}）\n示例：{ex}"
    },
    en: {
      pageTitle: "Medication + Vitals Tracker",
      langLabel: "Language",

      medScheduleTitle: "Medication schedule",
      colorLegendHtml: `Colors: <span class="pill ok">OK</span> <span class="pill soon">DUE SOON</span> <span class="pill due">DUE NOW</span> <span class="pill over">OVERDUE</span>`,
      soonWindowLabel: "Due soon window",
      soon15: "15 min",
      soon30: "30 min",
      soon60: "60 min",
      refresh: "Refresh",

      thMedicine: "Medicine",
      thEachTime: "Each time",
      thEvery: "Every",
      thLastTaken: "Last taken",
      thNextDose: "Next dose",
      thStatus: "Status",
      thActions: "Actions",

      resetAll: "Reset all",
      exportJson: "Export JSON",
      importJson: "Import JSON",

      tipHtml: `Tip: When you take a medicine, click <b>Take now</b> — it stores the timestamp and calculates the next dose.`,

      takeNow: "Take now",
      setTime: "Set time",

      vitalsTitle: "Vitals (Temperature + Heart Rate)",
      time: "Time",
      temp: "Temp",
      hr: "Heart rate",
      add: "Add",
      vitalsHelp: "Enter Temp and/or HR. If you enter both, they are saved as two separate items at the same time.",

      thVitalsTime: "Time",
      thVitalsTemp: "Temp (°C)",
      thVitalsHr: "HR (bpm)",
      thVitalsActions: "Actions",

      notesTitle: "Notes (standalone timeline)",
      howIFeel: "How I feel",
      addNote: "Add note",
      notesPlaceholder: "e.g., sore throat improving, mild headache, tired",

      delete: "Delete",

      status_ok: "OK",
      status_soon: "DUE SOON",
      status_due: "DUE NOW",
      status_over: "OVERDUE",

      alertEnterVitals: "Enter Temperature and/or Heart Rate first.",
      alertEnterNote: "Enter a note first.",
      alertInvalidTime: "Invalid date/time.",
      alertPiecesPositive: "Pieces must be a positive number.",
      resetConfirm: "Reset ALL meds + vitals + notes? This clears local data.",
      imported: "Imported!",
      importFailed: "Import failed. Make sure it's a JSON file exported from this page.",
      timeHintFull: "YYYY-MM-DD HH:MM",
      timeHintShort: "MM-DD HH:MM (or YYYY-MM-DD HH:MM)",
      promptSetLastTaken: "Set LAST TAKEN time for {name} (format: {fmt})\nExample: {ex}"
    }
  };

  function loadUi() {
    try {
      const raw = localStorage.getItem(UI_LS_KEY);
      if (!raw) return { lang: "zh" };
      const parsed = JSON.parse(raw);
      return { lang: parsed?.lang === "en" ? "en" : "zh" };
    } catch (_) {
      return { lang: "zh" };
    }
  }

  function saveUi(ui) {
    localStorage.setItem(UI_LS_KEY, JSON.stringify(ui));
  }

  let ui = loadUi();

  function t(key, vars) {
    const dict = I18N[ui.lang] || I18N.en;
    let s = dict[key] ?? I18N.en[key] ?? key;
    if (vars && typeof s === "string") {
      for (const [k, v] of Object.entries(vars)) {
        s = s.replaceAll(`{${k}}`, String(v));
      }
    }
    return s;
  }

  function applyI18n() {
    document.documentElement.lang = ui.lang === "zh" ? "zh-CN" : "en";

    const setText = (id, key) => {
      const el = document.getElementById(id);
      if (el) el.textContent = t(key);
    };
    const setHtml = (id, key) => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = t(key);
    };

    setText("pageTitle", "pageTitle");
    setText("langLabel", "langLabel");
    setText("medScheduleTitle", "medScheduleTitle");
    setHtml("colorLegend", "colorLegendHtml");
    setText("soonWindowLabel", "soonWindowLabel");
    setText("soon15", "soon15");
    setText("soon30", "soon30");
    setText("soon60", "soon60");

    document.getElementById("refreshBtn").textContent = t("refresh");
    document.getElementById("resetAllBtn").textContent = t("resetAll");
    document.getElementById("exportBtn").textContent = t("exportJson");
    setText("importLabel", "importJson");
    setHtml("tipText", "tipHtml");

    setText("thMedicine", "thMedicine");
    setText("thEachTime", "thEachTime");
    setText("thEvery", "thEvery");
    setText("thLastTaken", "thLastTaken");
    setText("thNextDose", "thNextDose");
    setText("thStatus", "thStatus");
    setText("thActions", "thActions");

    setText("vitalsTitle", "vitalsTitle");
    setText("vitalsTimeLabel", "time");
    setText("tempLabel", "temp");
    setText("hrLabel", "hr");
    document.getElementById("addVitalsBtn").textContent = t("add");
    setText("vitalsHelp", "vitalsHelp");

    setText("thVitalsTime", "thVitalsTime");
    setText("thVitalsTemp", "thVitalsTemp");
    setText("thVitalsHr", "thVitalsHr");
    setText("thVitalsActions", "thVitalsActions");

    setText("notesTitle", "notesTitle");
    setText("notesTimeLabel", "time");
    setText("notesFeelLabel", "howIFeel");
    document.getElementById("addNoteBtn").textContent = t("addNote");
    const notesText = document.getElementById("notesTextInput");
    if (notesText) notesText.placeholder = t("notesPlaceholder");
  }

  // --------- CONFIG (rename meds here if you want) ----------
  const DEFAULT_MEDS = [
    {
      id: "prednisone",
      name: "醋酸泼尼松片（力生）5MG",
      usage: "用法：每次6片 口服 每日两次",
      intervalHours: 12,
      dosePieces: 6,
      doseUnit: "片"
    },
    {
      id: "cyclophosphamide",
      name: "环磷酰胺片（56）50MG",
      usage: "用法：每次1片 口服 每日一次",
      intervalHours: 24,
      dosePieces: 1,
      doseUnit: "片"
    },
    {
      id: "calcium_carbonate",
      name: "碳酸钙片（钙达利）500MG",
      usage: "用法：每次1片 口服 每日三次",
      intervalHours: 8,
      dosePieces: 1,
      doseUnit: "片"
    },
    {
      id: "calcitriol",
      name: "骨化三醇软胶囊（盖三淳）0.25UG",
      usage: "用法：每次1粒 口服 每日两次",
      intervalHours: 12,
      dosePieces: 1,
      doseUnit: "粒"
    },
  ];

  // --------- STORAGE ----------
  const LS_KEY = "med_tracker_v1";

   function genId() {
     try {
       if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") return crypto.randomUUID();
     } catch (_) {}
     return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
   }

   function ensureVitalIds(vitals) {
     let changed = false;
     const out = (Array.isArray(vitals) ? vitals : []).map((v) => {
      if (v && typeof v === "object" && v.id) return v;
      changed = true;
      const base = (v && typeof v === "object") ? v : {};
      return { ...base, id: genId() };
     });
     return { vitals: out, changed };
   }

   function ensureNoteIds(notes) {
     let changed = false;
     const out = (Array.isArray(notes) ? notes : []).map((n) => {
      if (n && typeof n === "object" && n.id) return n;
      changed = true;
      const base = (n && typeof n === "object") ? n : {};
      return { ...base, id: genId() };
     });
     return { notes: out, changed };
   }

  function loadState() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return { meds: DEFAULT_MEDS.map(m => ({...m, lastTakenISO: "", lastTakenPieces: ""})), vitals: [], notes: [] };
      const parsed = JSON.parse(raw);

      // Backward/forward tolerance
      const medsById = new Map((parsed.meds || []).map(m => [m.id, m]));
      const meds = DEFAULT_MEDS.map(m => {
        const saved = medsById.get(m.id);
        const savedDosePieces = Number(saved?.dosePieces);
        const dosePieces = Number.isFinite(savedDosePieces) && savedDosePieces > 0 ? savedDosePieces : m.dosePieces;
        return {
          ...m,
          dosePieces,
          lastTakenISO: saved?.lastTakenISO || "",
          lastTakenPieces: saved?.lastTakenPieces ?? ""
        };
      });

      return {
        meds,
        vitals: Array.isArray(parsed.vitals) ? parsed.vitals : [],
        notes: Array.isArray(parsed.notes) ? parsed.notes : []
      };
    } catch (e) {
      console.warn("Failed to load state:", e);
      return { meds: DEFAULT_MEDS.map(m => ({...m, lastTakenISO: "", lastTakenPieces: ""})), vitals: [], notes: [] };
    }
  }

  function saveState(state) {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  let state = loadState();

  // One-time migrations for older saved data
  (function migrate() {
    const v = ensureVitalIds(state.vitals);
    const n = ensureNoteIds(state.notes);
    state.vitals = v.vitals;
    state.notes = n.notes;
    if (v.changed || n.changed) saveState(state);
  })();

  // --------- TIME HELPERS ----------
  function nowMs() { return Date.now(); }
  function isoToMs(iso) { return iso ? new Date(iso).getTime() : NaN; }
  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }
  function msToLocalInput(ms) {
    const d = new Date(ms);
    const pad = n => String(n).padStart(2, "0");
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth() + 1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }

  function msToLocalSpaceInput(ms) {
    return msToLocalInput(ms).replace("T", " ");
  }

  function parseLocalDateTime(str) {
    const s = String(str || "").trim();
    if (!s) return null;

    // Full: YYYY-MM-DD HH:MM (or YYYY-MM-DDTHH:MM)
    let m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})$/);
    if (m) {
      const yyyy = Number(m[1]);
      const mm = Number(m[2]);
      const dd = Number(m[3]);
      const hh = Number(m[4]);
      const mi = Number(m[5]);
      const dt = new Date(yyyy, mm - 1, dd, hh, mi, 0, 0); // local time
      return isNaN(dt.getTime()) ? null : dt;
    }

    // Short: MM-DD HH:MM (assumes current year)
    m = s.match(/^(\d{2})-(\d{2})[ T](\d{2}):(\d{2})$/);
    if (m) {
      const yyyy = new Date().getFullYear();
      const mm = Number(m[1]);
      const dd = Number(m[2]);
      const hh = Number(m[3]);
      const mi = Number(m[4]);
      const dt = new Date(yyyy, mm - 1, dd, hh, mi, 0, 0); // local time
      return isNaN(dt.getTime()) ? null : dt;
    }

    return null;
  }

  function msToPretty(ms) {
    if (!Number.isFinite(ms)) return "";
    const d = new Date(ms);
    const pad = n => String(n).padStart(2, "0");
    const mm = pad(d.getMonth() + 1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    if (prettyOmitYear) return `${mm}-${dd} ${hh}:${mi}`;
    const yyyy = d.getFullYear();
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  function msToInputTime(ms) {
    const d = new Date(ms);
    const pad = n => String(n).padStart(2, "0");
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth() + 1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    return inputOmitYear ? `${mm}-${dd} ${hh}:${mi}` : `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  let prettyOmitYear = false;
  let inputOmitYear = false;

  function updateYearModes() {
    const yearsHistory = new Set();

    // Meds: last taken + next dose (derived)
    for (const med of state.meds) {
      const lastMs = isoToMs(med.lastTakenISO);
      if (Number.isFinite(lastMs)) {
        yearsHistory.add(new Date(lastMs).getFullYear());
        const nextMs = computeNextMs(med);
        if (Number.isFinite(nextMs)) yearsHistory.add(new Date(nextMs).getFullYear());
      }
    }

    // Vitals
    for (const v of state.vitals) {
      const tMs = isoToMs(v.timeISO);
      if (Number.isFinite(tMs)) yearsHistory.add(new Date(tMs).getFullYear());
    }

    // Notes
    for (const n of state.notes) {
      const tMs = isoToMs(n.timeISO);
      if (Number.isFinite(tMs)) yearsHistory.add(new Date(tMs).getFullYear());
    }

    // Display: omit year if all recorded times are within one year
    prettyOmitYear = yearsHistory.size <= 1;

    // Inputs: omit year only if current year matches all history
    const yearsInput = new Set(yearsHistory);
    yearsInput.add(new Date().getFullYear());
    inputOmitYear = yearsInput.size === 1;
  }

  // --------- STATUS / COLOR ----------
  function computeNextMs(med) {
    const lastMs = isoToMs(med.lastTakenISO);
    if (!Number.isFinite(lastMs)) return NaN;
    return lastMs + med.intervalHours * 3600 * 1000;
  }

  function computeStatus(nextMs, soonMinutes) {
    if (!Number.isFinite(nextMs)) return { code: "", cls: "" };

    const t = nowMs();
    const diff = nextMs - t; // ms

    if (diff <= -60 * 1000) return { code: "over", cls: "over" }; // 1 min grace
    if (diff <= 0) return { code: "due", cls: "due" };
    if (diff <= soonMinutes * 60 * 1000) return { code: "soon", cls: "soon" };
    return { code: "ok", cls: "ok" };
  }

  // --------- RENDER MEDS ----------
  const medTbody = document.querySelector("#medTable tbody");
  const soonWindowSel = document.getElementById("soonWindow");

  function renderMeds() {
    const soonMinutes = parseInt(soonWindowSel.value, 10) || 30;
    medTbody.innerHTML = "";

    state.meds.forEach((med) => {
      const nextMs = computeNextMs(med);
      const status = computeStatus(nextMs, soonMinutes);

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.innerHTML = `
        <span class="cellMain">${escapeHtml(med.name)}</span>
        ${med.usage ? `<span class="cellSub muted">${escapeHtml(med.usage)}</span>` : ""}
      `;

      const tdDose = document.createElement("td");
      tdDose.innerHTML = `
        <div class="row">
          <input
            class="small"
            type="number"
            min="0"
            step="1"
            value="${Number(med.dosePieces) || ""}"
            data-act="setDosePieces"
            data-id="${med.id}"
            aria-label="Pieces each time"
          />
          <span class="muted">${escapeHtml(med.doseUnit || "")}</span>
        </div>
      `;

      const tdEvery = document.createElement("td");
      tdEvery.innerHTML = `<span class="mono">${med.intervalHours}h</span>`;

      const tdLast = document.createElement("td");
      tdLast.className = "nowrap";
      if (!med.lastTakenISO) {
        tdLast.textContent = "—";
      } else {
        const parts = [];
        parts.push(`<span class="cellMain">${escapeHtml(msToPretty(isoToMs(med.lastTakenISO)))}</span>`);
        if (med.lastTakenPieces !== "" && med.lastTakenPieces !== null && med.lastTakenPieces !== undefined) {
          const unit = med.doseUnit ? ` ${escapeHtml(med.doseUnit)}` : "";
          parts.push(`<span class="cellSub muted">${escapeHtml(String(med.lastTakenPieces))}${unit}</span>`);
        }
        tdLast.innerHTML = parts.join("");
      }

      const tdNext = document.createElement("td");
      tdNext.className = "nowrap";
      tdNext.textContent = Number.isFinite(nextMs) ? msToPretty(nextMs) : "—";

      const tdStatus = document.createElement("td");
      if (!status.code) {
        tdStatus.innerHTML = `<span class="pill">—</span>`;
      } else {
        tdStatus.innerHTML = `<span class="pill ${status.cls}">${escapeHtml(t(`status_${status.code}`))}</span>`;
      }

      const tdActions = document.createElement("td");
      tdActions.className = "right";
      tdActions.innerHTML = `
        <div class="row" style="justify-content:flex-end;">
          <button class="small primary" data-act="takeNow" data-id="${med.id}">${escapeHtml(t("takeNow"))}</button>
          <button class="small" data-act="editTime" data-id="${med.id}">${escapeHtml(t("setTime"))}</button>
        </div>
      `;

      tr.appendChild(tdName);
      tr.appendChild(tdDose);
      tr.appendChild(tdEvery);
      tr.appendChild(tdLast);
      tr.appendChild(tdNext);
      tr.appendChild(tdStatus);
      tr.appendChild(tdActions);

      medTbody.appendChild(tr);
    });
  }

  medTbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const med = state.meds.find(m => m.id === id);
    if (!med) return;

    if (act === "takeNow") {
      med.lastTakenISO = new Date().toISOString();
      med.lastTakenPieces = Number.isFinite(Number(med.dosePieces)) ? Number(med.dosePieces) : "";
      saveState(state);
      renderAll();
      return;
    }

    if (act === "editTime") {
      const currentMs = isoToMs(med.lastTakenISO);
      const preset = Number.isFinite(currentMs) ? msToLocalSpaceInput(currentMs) : msToLocalSpaceInput(nowMs());
      const fmt = inputOmitYear ? t("timeHintShort") : t("timeHintFull");
      const ex = inputOmitYear ? "02-13 09:20" : "2026-02-13 09:20";
      const input = prompt(t("promptSetLastTaken", { name: med.name, fmt, ex }), preset);
      if (!input) return;

      const dt = parseLocalDateTime(input);
      if (!dt) {
        alert(`${t("alertInvalidTime")} ${t("timeHintShort")}`);
        return;
      }
      med.lastTakenISO = dt.toISOString();
      saveState(state);
      renderAll();
      return;
    }
  });

  medTbody.addEventListener("change", (e) => {
    const el = e.target;
    if (!(el instanceof HTMLInputElement)) return;
    if (el.dataset.act !== "setDosePieces") return;
    const id = el.dataset.id;
    const med = state.meds.find(m => m.id === id);
    if (!med) return;

    const raw = el.value.trim();
    if (!raw) {
      med.dosePieces = "";
      saveState(state);
      renderAll();
      return;
    }

    const n = Number(raw);
    if (!Number.isFinite(n) || n <= 0) {
      alert(t("alertPiecesPositive"));
      el.value = String(med.dosePieces ?? "");
      return;
    }

    med.dosePieces = Math.round(n);
    saveState(state);
    renderAll();
  });

  // --------- VITALS ----------
  const vitalsTbody = document.querySelector("#vitalsTable tbody");
  const tempInput = document.getElementById("tempInput");
  const hrInput = document.getElementById("hrInput");
  const vitalsTimeInput = document.getElementById("vitalsTimeInput");
  const addVitalsBtn = document.getElementById("addVitalsBtn");

  function timeFormatHint() {
    return inputOmitYear ? "MM-DD HH:MM (or YYYY-MM-DD HH:MM)" : "YYYY-MM-DD HH:MM";
  }

  function syncTimeInputUI(inputEl) {
    if (!inputEl) return;
    inputEl.placeholder = inputOmitYear ? "MM-DD HH:MM" : "YYYY-MM-DD HH:MM";

    // Only auto-fill when user hasn't manually edited
    if (inputEl.dataset.auto === "0") return;
    if (!inputEl.value) {
      inputEl.value = msToInputTime(nowMs());
      inputEl.dataset.auto = "1";
    }
  }

  function renderVitals() {
    vitalsTbody.innerHTML = "";
    state.vitals
      .slice()
      .sort((a,b) => b.timeISO.localeCompare(a.timeISO))
      .forEach((v) => {
        const tr = document.createElement("tr");

        const tdTime = document.createElement("td");
        tdTime.className = "nowrap";
        tdTime.textContent = msToPretty(isoToMs(v.timeISO));

        const tdTemp = document.createElement("td");
        tdTemp.textContent = (v.tempC ?? "") === "" ? "—" : String(v.tempC);

        const tdHr = document.createElement("td");
        tdHr.textContent = (v.hrBpm ?? "") === "" ? "—" : String(v.hrBpm);

        const tdAct = document.createElement("td");
        tdAct.className = "right";
        tdAct.innerHTML = `<button class="small" data-act="delVital" data-id="${v.id}">${escapeHtml(t("delete"))}</button>`;

        tr.appendChild(tdTime);
        tr.appendChild(tdTemp);
        tr.appendChild(tdHr);
        tr.appendChild(tdAct);

        vitalsTbody.appendChild(tr);
      });
  }

  function readVitalsTimeOrAlert() {
    const tInput = vitalsTimeInput.value;
    const dt = tInput ? parseLocalDateTime(tInput) : new Date();
    if (!dt) {
      alert(`Invalid date/time. Use format ${timeFormatHint()}`);
      return null;
    }
    return dt;
  }

  function pushVital(partial) {
    const entry = {
      id: genId(),
      timeISO: partial.timeISO,
      tempC: partial.tempC ?? "",
      hrBpm: partial.hrBpm ?? ""
    };
    state.vitals.push(entry);
  }

  addVitalsBtn.addEventListener("click", () => {
    const temp = tempInput.value.trim();
    const hr = hrInput.value.trim();

    if (!temp && !hr) {
      alert(t("alertEnterVitals"));
      return;
    }

    const dt = readVitalsTimeOrAlert();
    if (!dt) return;
    const timeISO = dt.toISOString();

    // Store as separate items (even if entered together)
    if (temp) pushVital({ timeISO, tempC: Number(temp) });
    if (hr) pushVital({ timeISO, hrBpm: Number(hr) });

    saveState(state);
    tempInput.value = "";
    hrInput.value = "";
    renderAll();
  });

  vitalsTbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    if (btn.dataset.act === "delVital") {
      const id = btn.dataset.id;
      if (!id) return;
      state.vitals = state.vitals.filter(v => v.id !== id);
      saveState(state);
      renderAll();
    }
  });

  // --------- NOTES ----------
  const notesTbody = document.querySelector("#notesTable tbody");
  const notesTimeInput = document.getElementById("notesTimeInput");
  const notesTextInput = document.getElementById("notesTextInput");

  function renderNotes() {
    notesTbody.innerHTML = "";
    state.notes
      .slice()
      .sort((a,b) => b.timeISO.localeCompare(a.timeISO))
      .forEach((n) => {
        const tr = document.createElement("tr");

        const tdTime = document.createElement("td");
        tdTime.className = "nowrap";
        tdTime.textContent = msToPretty(isoToMs(n.timeISO));

        const tdText = document.createElement("td");
        tdText.textContent = n.text || "";

        const tdAct = document.createElement("td");
        tdAct.className = "right";
        tdAct.innerHTML = `<button class="small" data-act="delNote" data-id="${n.id}">${escapeHtml(t("delete"))}</button>`;

        tr.appendChild(tdTime);
        tr.appendChild(tdText);
        tr.appendChild(tdAct);

        notesTbody.appendChild(tr);
      });
  }

  document.getElementById("addNoteBtn").addEventListener("click", () => {
    const text = notesTextInput.value.trim();
    if (!text) {
      alert(t("alertEnterNote"));
      return;
    }

    const tInput = notesTimeInput.value;
    const dt = tInput ? parseLocalDateTime(tInput) : new Date();
    if (!dt) {
      alert(`Invalid date/time. Use format ${timeFormatHint()}`);
      return;
    }

    state.notes.push({
      id: genId(),
      timeISO: dt.toISOString(),
      text
    });

    saveState(state);
    notesTextInput.value = "";
    renderAll();
  });

  notesTbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    if (btn.dataset.act === "delNote") {
      const id = btn.dataset.id;
      if (!id) return;
      state.notes = state.notes.filter(n => n.id !== id);
      saveState(state);
      renderAll();
    }
  });

  // --------- EXPORT / IMPORT / RESET ----------
  document.getElementById("resetAllBtn").addEventListener("click", () => {
    if (!confirm(t("resetConfirm"))) return;
    state = { meds: DEFAULT_MEDS.map(m => ({...m, lastTakenISO:"", lastTakenPieces:""})), vitals: [], notes: [] };
    saveState(state);
    updateYearModes();
    vitalsTimeInput.dataset.auto = "1";
    notesTimeInput.dataset.auto = "1";
    vitalsTimeInput.value = "";
    notesTimeInput.value = "";
    syncTimeInputUI(vitalsTimeInput);
    syncTimeInputUI(notesTimeInput);
    notesTextInput.value = "";
    renderAll();
  });

  document.getElementById("exportBtn").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "med-tracker-backup.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById("importFile").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const parsed = JSON.parse(text);
      // Minimal validation + merge with DEFAULT_MEDS
      const medsById = new Map((parsed.meds || []).map(m => [m.id, m]));
      state.meds = DEFAULT_MEDS.map(m => {
        const saved = medsById.get(m.id) || {};
        const savedDosePieces = Number(saved.dosePieces);
        const dosePieces = Number.isFinite(savedDosePieces) && savedDosePieces > 0 ? savedDosePieces : m.dosePieces;
        return {
          ...m,
          dosePieces,
          lastTakenISO: saved.lastTakenISO || "",
          lastTakenPieces: saved.lastTakenPieces ?? ""
        };
      });
      const v = ensureVitalIds(Array.isArray(parsed.vitals) ? parsed.vitals : []);
      const n = ensureNoteIds(Array.isArray(parsed.notes) ? parsed.notes : []);
      state.vitals = v.vitals;
      state.notes = n.notes;
      saveState(state);
      updateYearModes();
      vitalsTimeInput.dataset.auto = "1";
      notesTimeInput.dataset.auto = "1";
      vitalsTimeInput.value = "";
      notesTimeInput.value = "";
      syncTimeInputUI(vitalsTimeInput);
      syncTimeInputUI(notesTimeInput);
      notesTextInput.value = "";
      renderAll();
      alert(t("imported"));
    } catch (err) {
      alert(t("importFailed"));
    } finally {
      e.target.value = "";
    }
  });

  // --------- REFRESH + AUTO UPDATE ----------
  document.getElementById("refreshBtn").addEventListener("click", renderAll);
  soonWindowSel.addEventListener("change", renderAll);

  function renderAll() {
    updateYearModes();
    syncTimeInputUI(vitalsTimeInput);
    syncTimeInputUI(notesTimeInput);
    renderMeds();
    renderVitals();
    renderNotes();
  }

  vitalsTimeInput.addEventListener("input", () => { vitalsTimeInput.dataset.auto = "0"; });
  notesTimeInput.addEventListener("input", () => { notesTimeInput.dataset.auto = "0"; });

  // Initialize default time inputs
  updateYearModes();
  vitalsTimeInput.dataset.auto = "1";
  notesTimeInput.dataset.auto = "1";
  syncTimeInputUI(vitalsTimeInput);
  syncTimeInputUI(notesTimeInput);
  renderAll();
  setInterval(renderMeds, 30 * 1000); // update due colors every 30s
</script>
</body>
</html>
